<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="LibreNMS">
    <link rel="canonical" href="https://www.librenms.org/docs/Extensions/Varnish/">
    <link rel="shortcut icon" href="../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Varnish Installation Guide # - LibreNMS Docs</title>
    <link href="../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/highlight.css">
    <link href="../../librenms.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../js/jquery-3.2.1.min.js"></script>
    <script src="../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Varnish Installation Guide", url: "#varnish-installation-guide", children: [
              {title: "Simplified block diagram of an Apache HTTP server with Varnish 4.0 Reverse Proxy.", url: "#simplified-block-diagram-of-an-apache-http-server-with-varnish-40-reverse-proxy" },
              {title: "CentOS 7 Varnish Installation", url: "#centos-7-varnish-installation" },
          ]},
        ];

    </script>
    <script src="../../js/base.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-79149977-2', 'docs.librenms.org');
        ga('send', 'pageview');
    </script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
    
      <div class="source-links">
      
          <span class="label label-primary"><a href="https://github.com/librenms/librenms//edit/master/doc/Extensions/Varnish.md" target="_blank" style="color:#ffffff"><i class="fa fa-pencil"></i> Edit on GitHub</a></span>
      
      </div>
    

    <h1 id="varnish-installation-guide">Varnish Installation Guide</h1>
<p>This document explains how to install Varnish Reverse Proxy for LibreNMS.</p>
<p>Varnish is caching software that sits logically between an HTTP client and an HTTP server. Varnish caches HTTP responses from the HTTP server. If an HTTP request can not be responded to by the Varnish cache it directs the request to the HTTP Server. This type of HTTP caching is called a reverse proxy server. Caching your HTTP server can decrease page load times significantly.
<br><br></p>
<h5 id="simplified-block-diagram-of-an-apache-http-server-with-varnish-40-reverse-proxy"><center>Simplified block diagram of an Apache HTTP server with Varnish 4.0 Reverse Proxy.</center></h5>
<p><img alt="Block Diagram 1" src="http://docs.librenms.org/img/varnish_block.png" /></p>
<h3 id="centos-7-varnish-installation">CentOS 7 Varnish Installation</h3>
<p>In this example we will assume your Apache 2.4.X HTTP server is working and
configured to process HTTP requests on port 80.  If not, please see
<a href="http://librenms.readthedocs.org/Installation/Installing-CentOS-7-Apache">Installing LibreNMS</a></p>
<h4 id="install-varnish-40-rpm">Install Varnish 4.0 RPM</h4>
<ul>
<li>Enable the Varnish CentOS 7 repo and install</li>
</ul>
<pre><code class="bash">rpm --nosignature -i https://repo.varnish-cache.org/redhat/varnish-4.0.el7.rpm
yum install varnish
</code></pre>

<p>By default Varnish listens for HTTP requests on port 6081.</p>
<ul>
<li>Temporarily add a firewalld rule for testing Varnish.</li>
</ul>
<pre><code class="bash">firewall-cmd --zone=public --add-port=6081/tcp
</code></pre>

<h4 id="test-varnish">Test Varnish</h4>
<ul>
<li>Start Varnish</li>
</ul>
<pre><code class="bash">systemctl start varnish
</code></pre>

<p>Using a web browser navigate to <server ip addr>:6081 or 127.0.0.1:6081. You should see a Varnish error message, this shows that Varnish is working. Example error message:</p>
<pre><code class="ssh">Error 503 Backend fetch failed

Backend fetch failed

Guru Meditation:

XID: 3

Varnish cache server

</code></pre>

<h4 id="edit-varnish-parameters">Edit Varnish Parameters</h4>
<p>Now we need to configure Varnish to listen to HTTP requests on port 80 and
relay those requests to the Apache HTTP server on port 8080 (see block diagram).</p>
<ul>
<li>Stop Varnish.</li>
</ul>
<pre><code class="bash">systemctl stop varnish
</code></pre>

<ul>
<li>Create a back-up of varnish.params just in case you make a mistake.</li>
</ul>
<pre><code class="bash">cp /etc/varnish/varnish.params /etc/varnish/varnish.params.bak
</code></pre>

<ul>
<li>Edit the varnish.params config.</li>
</ul>
<pre><code class="bash">vim /etc/varnish/varnish.params
</code></pre>

<p>Set the VCL location, IP address, port, and cache location and size. <code>malloc</code> sets the cache location to RAM, and <code>512M</code> sets the cache size to 512MB.</p>
<pre><code class="vcl">VARNISH_LISTEN_ADDRESS=192.168.1.10
VARNISH_LISTEN_PORT=80
VARNISH_VCL_CONF=/etc/varnish/librenms.vcl
VARNISH_STORAGE=&quot;malloc,512M&quot;
</code></pre>

<p>Example varnish.params:</p>
<pre><code class="vcl"># Set this to 1 to make systemd reload try to switch vcl without restart.
RELOAD_VCL=1

# Main configuration file. You probably want to change it.
VARNISH_VCL_CONF=/etc/varnish/librenms.vcl

# Default address and port to bind to. Blank address means all IPv4
# and IPv6 interfaces, otherwise specify a host name, an IPv4 dotted
# quad, or an IPv6 address in brackets.
VARNISH_LISTEN_ADDRESS=192.168.1.10
VARNISH_LISTEN_PORT=80

# Admin interface listen address and port
VARNISH_ADMIN_LISTEN_ADDRESS=127.0.0.1
VARNISH_ADMIN_LISTEN_PORT=6082

# Shared secret file for admin interface
VARNISH_SECRET_FILE=/etc/varnish/secret

# Backend storage specification, see Storage Types in the varnishd(5)
# man page for details.
VARNISH_STORAGE=&quot;malloc,512M&quot;

# Default TTL used when the backend does not specify one
VARNISH_TTL=120

# User and group for the varnishd worker processes
VARNISH_USER=varnish
VARNISH_GROUP=varnish

# Other options, see the man page varnishd(1)
DAEMON_OPTS=&quot;-p thread_pool_min=5 -p thread_pool_max=500 -p thread_pool_timeout=300&quot;
</code></pre>

<h4 id="configure-apache-for-varnish">Configure Apache for Varnish</h4>
<p>Edit librenms.conf and modify the Apache Virtual Host listening port.</p>
<ul>
<li>Modify:<code>&lt;VirtualHost *:80&gt;</code> to: <code>&lt;VirtualHost *:8080&gt;</code></li>
</ul>
<pre><code class="bash">vim /etc/httpd/conf.d/librenms.conf
</code></pre>

<p>Varnish can not share a port with Apache. Change the Apache listening port to 8080.</p>
<ul>
<li>Modify:<code>Listen 80</code> to:<code>Listen 8080</code></li>
</ul>
<pre><code class="bash">vim /etc/httpd/conf/httpd.conf
</code></pre>

<ul>
<li>Create the librenms.vcl</li>
</ul>
<pre><code class="bash">cd /etc/varnish
touch librenms.vcl
</code></pre>

<ul>
<li>Set ownership and permissions for Varnish files.</li>
</ul>
<pre><code class="bash">chown varnish:varnish default.vcl varnish.params secret
chmod 644 default.vcl varnish.params secret
</code></pre>

<p>Edit the librenms.vcl.</p>
<pre><code class="bash">vim librenms.vcl
</code></pre>

<p>Paste example VCL config, read config comments for more information.</p>
<pre><code class="vcl">#
# This is an example VCL file for Varnish.
#
# It does not do anything by default, delegating control to the
# builtin VCL. The builtin VCL is called when there is no explicit
# return statement.
#
# See the VCL chapters in the Users Guide at https://www.varnish-cache.org/docs/
# and http://varnish-cache.org/trac/wiki/VCLExamples for more examples.

# Marker to tell the VCL compiler that this VCL has been adapted to the
# new 4.0 format.
vcl 4.0;

# Default backend definition. Set this to point to your Apache server.
backend librenms {
    .host = &quot;127.0.0.1&quot;;
    .port = &quot;8080&quot;;
}

# In this example our objective is to cache static content with Varnish and temporarily
# cache dynamic content in the client web browser.

sub vcl_recv {
    # HTTP requests from client web browser.
    # Here we remove any cookie HTTP requests for the 'librenms.domain.net' host
    # containing the matching file extensions. We don't have to match by host if you
    # only have LibreNMS running on Apache.
    # If the cookies are not removed from the HTTP request then Varnish will not cache
    # the files. 'else' function is set to 'pass', or don't cache anything that doesn't
    # match.

    if (req.http.host ~ &quot;^librenms.domain.net&quot;) {
        set req.backend_hint = librenms;
        if (req.url ~ &quot;\.(png|gif|jpg|jpeg|ico|pdf|js|css|svg|eot|otf|woff|woff2|ttf)$&quot;) {
            unset req.http.Cookie;
        }

        else{
            return(pass);
        }
    }
}

sub vcl_backend_response {
    # 'sub vcl_backend_response' is the same function as 'sub vcl_fetch' in Varnish 3, however,
    # the syntax is slightly different
    # This function happens after we read the response headers from the backend (Apache).
    # First function 'if (bereq.url ~ &quot;\' removes cookies from the Apache HTTP responses
    # that match the file extensions that are between the quotes, and cache the files for 24 hours.
    # This assumes you update LibreNMS once a day, otherwise restart Varnish to clear cache.
    # Second function 'if (bereq.url ~ &quot;^/' removes the Pragma no-cache statements and sets the age
    # of how long the client browser will cache the matching urls.
    # LibreNMS graphs are updated every 300 seconds, 'max-age=300' is set to match this behavior.
    # We could cache these URLs in Varnish but it would add to the complexity of the config.

    if (bereq.http.host ~ &quot;^librenms.domain.net&quot;) {
        if (bereq.url ~ &quot;\.(png|gif|jpg|jpeg|ico|pdf|js|css|svg|eot|otf|woff|woff2|ttf)$&quot;) {
            unset beresp.http.Set-cookie;
            set beresp.ttl = 24h;
        }

        if (bereq.url ~ &quot;^/graph.php&quot; || &quot;^/device/&quot; || &quot;^/iftype/&quot; || &quot;^/customers/&quot; || &quot;^/health/&quot; || &quot;^/apps/&quot; || &quot;^/(plugin)$&quot; || &quot;^/(alert)$&quot; || &quot;^/eventlog/&quot; || &quot;^/graphs/&quot; || &quot;^/ports/&quot; ) {
            unset beresp.http.Pragma;
            set beresp.http.Cache-Control = &quot;max-age=300&quot;;
        }
    }
}

sub vcl_deliver {
    # Happens when we have all the pieces we need, and are about to send the
    # response to the client.
    # You can do accounting or modifying the final object here.

    return (deliver);
}
</code></pre>

<ul>
<li>Reload rules to remove the temporary port rule we added earlier.</li>
</ul>
<pre><code class="bash">firewall-cmd --reload
</code></pre>

<p>Varnish caching does not take effect immediately.  You will need to browse the LibreNMS website to build up the cache.</p>
<p>Use the command <code>varnishstat</code> to monitor Varnish caching.  Over time you should see 'MAIN.cache_hit' and 'MAIN.client_req' increase.  With the above VCL the hit to request ratio is approximately 84%.</p>
<ul>
<li>
<p>Session based VCL (coming soon)</p>
</li>
<li>
<p>Testing and debugging VCL (coming soon)</p>
</li>
</ul>

  <br>
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="Extensions/Poller-Service/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="Extensions/Poller-Service/" class="btn btn-xs btn-link">
        Poller Service (BETA)
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="Extensions/Sub-Directory/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="Extensions/Sub-Directory/" class="btn btn-xs btn-link">
        Sub-directory Support
      </a>
    </div>
    
  </div>


    <br>
</div>

<footer class="col-md-12 wm-page-content">
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>