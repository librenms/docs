<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="LibreNMS">
    <link rel="canonical" href="https://www.librenms.org/docs/Developing/Sensor-State-Support/">
    <link rel="shortcut icon" href="../../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>Sensor State Support - LibreNMS Docs</title>
    <link href="../../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../../css/highlight.css">
    <link href="../../librenms.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../../js/jquery-3.2.1.min.js"></script>
    <script src="../../js/bootstrap-3.3.7.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '../..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Sensor State Support", url: "#sensor-state-support", children: [
              {title: "Introduction", url: "#introduction" },
              {title: "Logic", url: "#logic" },
              {title: "Example", url: "#example" },
              {title: "Advanced Example", url: "#advanced-example" },
          ]},
        ];

    </script>
    <script src="../../js/base.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-79149977-2', 'docs.librenms.org');
        ga('send', 'pageview');
    </script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
    
      <div class="source-links">
      
          <span class="label label-primary"><a href="https://github.com/librenms/librenms//edit/master/doc/Developing/Sensor-State-Support.md" target="_blank" style="color:#ffffff"><i class="fa fa-pencil"></i> Edit on GitHub</a></span>
      
      </div>
    

    <h1 id="sensor-state-support">Sensor State Support</h1>
<h3 id="introduction">Introduction</h3>
<p>In this section we are briefly going to walk through, what it takes to write sensor state support.
We will also briefly get around the concepts of the current sensor state monitoring.</p>
<h3 id="logic">Logic</h3>
<p>For sensor state monitoring, we have 4 DB tables we need to concentrate about.
- sensors
- state_indexes
- state_translations
- sensors_to_state_indexes</p>
<p>We will just briefly tie a comment to each one of them.</p>
<h4 id="sensors">Sensors</h4>
<p><em>Each time a sensor needs to be polled, the system needs to know which sensor is it that it need to poll, at what oid is this sensor located and what class the sensor is etc.
This information is fetched from the sensors table.</em></p>
<h4 id="state_indexes">state_indexes</h4>
<p><em>Is where we keep track of which state sensors we monitor.</em></p>
<h4 id="state_translations">state_translations</h4>
<p><em>Is where we map the possible returned state sensor values to a generic LibreNMS value, in order to make displaying and alerting more generic.
We also map these values to the actual state sensor(state_index) where these values are actually returned from.</em></p>
<p><em>The LibreNMS generic states are derived from Nagios:</em></p>
<pre><code>0 = OK
1 = Warning
2 = Critical
3 = Unknown
</code></pre>

<h4 id="sensors_to_state_indexes">sensors_to_state_indexes</h4>
<p><em>Is as you might have guessed, where the sensor_id is mapped to a state_index_id.</em></p>
<h3 id="example">Example</h3>
<p>For YAML based state discovery:</p>
<pre><code class="yaml">mib: NETBOTZV2-MIB
modules:
    sensors:
        state:
            data:
                -
                    oid: dryContactSensorTable
                    value: dryContactSensorValue
                    num_oid: .1.3.6.1.4.1.5528.100.4.2.1.1.2.
                    descr: dryContactSensorLabel
                    index: 'dryContactSensor.{{ $index }}'
                    state_name: dryContactSensor
                    states:
                        - { value: -1, generic: 3, graph: 0, descr: 'null' }
                        - { value:  0, generic: 0, graph: 0, descr: open }
                        - { value:  1, generic: 2, graph: 0, descr: closed }
                -
                    oid: doorSwitchSensorTable
                    value: doorSwitchSensorValue
                    num_oid: .1.3.6.1.4.1.5528.100.4.2.2.1.2.
                    descr: doorSwitchSensorLabel
                    index: 'doorSwitchSensor.{{ $index }}'
                    state_name: doorSwitchSensor
                    states:
                        - { value: -1, generic: 3, graph: 0, descr: 'null' }
                        - { value:  0, generic: 0, graph: 0, descr: open }
                        - { value:  1, generic: 2, graph: 0, descr: closed }
                -
                    oid: cameraMotionSensorTable
                    value: cameraMotionSensorValue
                    num_oid: .1.3.6.1.4.1.5528.100.4.2.3.1.2.
                    descr: cameraMotionSensorLabel
                    index: 'cameraMotionSensor.{{ $index }}'
                    state_name: cameraMotionSensor
                    states:
                        - { value: -1, generic: 3, graph: 0, descr: 'null' }
                        - { value:  0, generic: 0, graph: 0, descr: noMotion }
                        - { value:  1, generic: 2, graph: 0, descr: motionDetected }
                -
                    oid: otherStateSensorTable
                    value: otherStateSensorErrorStatus
                    num_oid: .1.3.6.1.4.1.5528.100.4.2.10.1.3.
                    descr: otherStateSensorLabel
                    index: '{{ $index }}'
                    state_name: otherStateSensorErrorStatus
                    states:
                        - { value: 0, generic: 0, graph: 0, descr: normal }
                        - { value: 1, generic: 1, graph: 0, descr: info }
                        - { value: 2, generic: 1, graph: 0, descr: warning }
                        - { value: 3, generic: 2, graph: 0, descr: error }
                        - { value: 4, generic: 2, graph: 0, descr: critical }
                        - { value: 5, generic: 2, graph: 0, descr: failure }
</code></pre>

<h3 id="advanced-example">Advanced Example</h3>
<p>For advanced state discovery:</p>
<p>This example will be based on a Cisco power supply sensor and is all it takes to have sensor state support for Cisco power supplys in Cisco switches.
The file should be located in /includes/discovery/sensors/state/cisco.inc.php.</p>
<pre><code class="php">&lt;?php

$oids = snmpwalk_group($device, 'ciscoEnvMonSupplyStatusTable', 'CISCO-ENVMON-MIB');

if (!empty($oids)) {
    //Create State Index
    $state_name = 'ciscoEnvMonSupplyState';
    $states = array(
         array('value' =&gt; 1, 'generic' =&gt; 0, 'graph' =&gt; 0, 'descr' =&gt; 'normal'),
         array('value' =&gt; 2, 'generic' =&gt; 1, 'graph' =&gt; 0, 'descr' =&gt; 'warning'),
         array('value' =&gt; 3, 'generic' =&gt; 2, 'graph' =&gt; 0, 'descr' =&gt; 'critical'),
         array('value' =&gt; 4, 'generic' =&gt; 3, 'graph' =&gt; 0, 'descr' =&gt; 'shutdown'),
         array('value' =&gt; 5, 'generic' =&gt; 3, 'graph' =&gt; 0, 'descr' =&gt; 'notPresent'),
         array('value' =&gt; 6, 'generic' =&gt; 2, 'graph' =&gt; 0, 'descr' =&gt; 'notFunctioning'),
     );
    create_state_index($state_name, $states);

    $num_oid = '.1.3.6.1.4.1.9.9.13.1.5.1.3.';
    foreach ($oids as $index =&gt; $entry) {
        //Discover Sensors
        discover_sensor($valid['sensor'], 'state', $device, $num_oid.$index, $index, $state_name, $entry['ciscoEnvMonSupplyStatusDescr'], '1', '1', null, null, null, null, $entry['ciscoEnvMonSupplyState'], 'snmp', $index);

        //Create Sensor To State Index
        create_sensor_to_state_index($device, $state_name, $index);
    }
}
</code></pre>

  <br>
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="Developing/SNMP-Traps/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="Developing/SNMP-Traps/" class="btn btn-xs btn-link">
        Creating snmp trap handlers
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="Developing/os/Settings/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="Developing/os/Settings/" class="btn btn-xs btn-link">
        Optional OS Settings
      </a>
    </div>
    
  </div>


    <br>
</div>

<footer class="col-md-12 wm-page-content">
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>